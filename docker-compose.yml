version: '3.8'

services:
  # CLIP Similarity Search Service
  clip-service:
    build:
      context: ./services/clip-service
      dockerfile: Dockerfile
    container_name: clip-service
    ports:
      - "8001:8001"
    environment:
      - CLIP_MODEL_NAME=openai/clip-vit-base-patch32
      - VECTOR_DB_PATH=/app/data/faiss_index
      - METADATA_PATH=/app/data/metadata.json
    volumes:
      - clip-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Gemini Recommendation Service
  gemini-service:
    build:
      context: ./services/gemini-service
      dockerfile: Dockerfile
    container_name: gemini-service
    ports:
      - "8002:8002"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Stable Diffusion Virtual Try-On Service
  diffusion-service:
    build:
      context: ./services/diffusion-service
      dockerfile: Dockerfile
    container_name: diffusion-service
    ports:
      - "8003:8003"
    environment:
      - DIFFUSION_MODEL_NAME=runwayml/stable-diffusion-v1-5
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    volumes:
      - diffusion-models:/root/.cache/huggingface
    restart: unless-stopped
    # Uncomment if you have a GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Next.js Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_CLIP_API=http://localhost:8001
      - NEXT_PUBLIC_GEMINI_API=http://localhost:8002
      - NEXT_PUBLIC_DIFFUSION_API=http://localhost:8003
    depends_on:
      - clip-service
      - gemini-service
      - diffusion-service
    restart: unless-stopped

volumes:
  clip-data:
    driver: local
  diffusion-models:
    driver: local

networks:
  default:
    name: outfit-simulator-network
